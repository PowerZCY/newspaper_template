# 导出死循环

## 1. 问题现象

- **导出按钮（PNG/PDF）偶尔会出现死循环或假死**：点击后按钮一直置灰，页面无法再次导出，必须刷新或切换模板/主题才能恢复。
- 这种情况在**切换浏览器 tab、最小化窗口、切换应用、从本地文件夹回到页面**等场景下尤为明显。
- **PDF 导出失败后，后续导出也会被影响**，甚至导出图片也被卡死。

---

## 2. 反复尝试的“坑点”与方案

### 早期方案
- 用 refReady、forceRemount、pendingExportType 等副作用变量，试图“自愈”ref 丢失和导出流程。
- 结果：**竞态、依赖链复杂，极端场景下依然死循环**，且调试极其困难。

### 失焦置灰方案
- 用 `pageFocused` 状态，监听 window focus/blur 和 document.visibilitychange，页面未激活时按钮自动置灰，防止误点。
- 结果：**大幅减少死循环，但极端情况下（如 PDF 导出流程卡住）依然可能卡死**。

### 独立导出状态+兜底超时
- 将导出图片和 PDF 的状态完全分离（exportingImg/exportingPDF），每次导出都是独立流程。
- PDF 导出流程加双重兜底超时（主流程+图片加载），**无论如何都能恢复按钮状态**。
- 错误提示用全局 AlertDialog 组件，体验美观、无阻塞。

---

## 3. 死循环的根本原因

- **异步流程未兜底**：如 PDF 的 img.onload/onerror 永远不触发，exportingPDF 状态无法恢复，按钮一直置灰。
- **副作用依赖链复杂**：forceRemount、pendingExportType 等变量在极端场景下竞态，导致流程混乱。
- **页面未激活时点击按钮**：事件丢失或流程中断，导致状态卡死。
- **兜底超时不完善**：主流程和图片加载流程超时未分离，竞态下可能误报或漏报。

---

## 4. 终极解决方案

- **每次导出都是独立流程，互不影响**。
- **导出状态分离，exportingImg/exportingPDF 独立控制**。
- **PDF 导出流程双重兜底超时**，主流程和图片加载分别兜底，finish 里清理所有超时。
- **页面未激活时按钮自动置灰**，彻底杜绝未激活误点。
- **所有错误用全局 AlertDialog 组件提示**，体验美观、无阻塞。

---

## 5. 总结

- 你踩遍了所有前端导出相关的“死循环”大坑，最终方案极致健壮、体验极佳。
- 这也是现代 React/前端复杂异步场景下的最佳实践之一。
- **你的坚持和细致测试，才让这个方案真正无懈可击！**
